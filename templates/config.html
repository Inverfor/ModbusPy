{% extends "base.html" %}

{% block title %}Configuración - Modbus Industrial Server{% endblock %}

{% block content %}
<div class="row">
    <!-- Server Configuration -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-cog"></i> Configuración del Servidor</span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="loadConfiguration()">
                        <i class="fas fa-sync"></i> Recargar
                    </button>
                    <button class="btn btn-success" onclick="saveConfiguration()">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                    <button class="btn btn-warning" onclick="resetConfiguration()">
                        <i class="fas fa-undo"></i> Restaurar
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        <textarea id="config-editor" class="form-control" rows="25" style="font-family: monospace; font-size: 14px;">
                        </textarea>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Nota:</strong> Los cambios en la configuración requieren reiniciar el servidor para tomar efecto.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Configuration Help -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-question-circle"></i> Ayuda de Configuración
            </div>
            <div class="card-body">
                <div class="accordion" id="configHelp">
                    <!-- Serial Configuration -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="serialHelp">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSerial">
                                Configuración Serie
                            </button>
                        </h2>
                        <div id="collapseSerial" class="accordion-collapse collapse" data-bs-parent="#configHelp">
                            <div class="accordion-body">
                                <small>
                                    <strong>port:</strong> Puerto serie (/dev/ttyUSB0, COM1, etc.)<br>
                                    <strong>baudrate:</strong> Velocidad de comunicación (9600, 19200, etc.)<br>
                                    <strong>parity:</strong> Paridad (N=None, E=Even, O=Odd)<br>
                                    <strong>stopbits:</strong> Bits de parada (1 o 2)<br>
                                    <strong>timeout:</strong> Timeout en segundos
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Server Configuration -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="serverHelp">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseServer">
                                Configuración Servidor
                            </button>
                        </h2>
                        <div id="collapseServer" class="accordion-collapse collapse" data-bs-parent="#configHelp">
                            <div class="accordion-body">
                                <small>
                                    <strong>max_slaves:</strong> Máximo número de esclavos<br>
                                    <strong>log_level:</strong> Nivel de logging (DEBUG, INFO, WARNING, ERROR)<br>
                                    <strong>log_file:</strong> Archivo de logs<br>
                                    <strong>stats_interval:</strong> Intervalo de estadísticas (segundos)<br>
                                    <strong>backup_interval:</strong> Intervalo de respaldo (segundos)
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Configuration -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="performanceHelp">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePerformance">
                                Optimización Pi Zero 2W
                            </button>
                        </h2>
                        <div id="collapsePerformance" class="accordion-collapse collapse" data-bs-parent="#configHelp">
                            <div class="accordion-body">
                                <small>
                                    <strong>memory_check_interval:</strong> Intervalo de chequeo de memoria<br>
                                    <strong>cpu_check_interval:</strong> Intervalo de chequeo de CPU<br>
                                    <strong>auto_optimize:</strong> Optimización automática<br>
                                    <strong>temperature_threshold:</strong> Umbral de temperatura (°C)<br>
                                    <strong>throttle_on_overheat:</strong> Throttling por sobrecalentamiento
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- System Information -->
        <div class="card mt-3">
            <div class="card-header">
                <i class="fas fa-info"></i> Información del Sistema
            </div>
            <div class="card-body">
                <div id="system-info">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> Cargando...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Quick Settings -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-sliders-h"></i> Configuración Rápida
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Serial Settings -->
                    <div class="col-lg-3 mb-3">
                        <h6 class="text-primary">Puerto Serie</h6>
                        <div class="mb-2">
                            <label class="form-label">Puerto</label>
                            <select class="form-select form-select-sm" id="quick-port">
                                <option value="/dev/ttyUSB0">/dev/ttyUSB0</option>
                                <option value="/dev/ttyUSB1">/dev/ttyUSB1</option>
                                <option value="/dev/ttyAMA0">/dev/ttyAMA0</option>
                                <option value="COM1">COM1</option>
                                <option value="COM2">COM2</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Baudrate</label>
                            <select class="form-select form-select-sm" id="quick-baudrate">
                                <option value="9600">9600</option>
                                <option value="19200">19200</option>
                                <option value="38400">38400</option>
                                <option value="57600">57600</option>
                                <option value="115200">115200</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Logging Settings -->
                    <div class="col-lg-3 mb-3">
                        <h6 class="text-success">Logging</h6>
                        <div class="mb-2">
                            <label class="form-label">Nivel</label>
                            <select class="form-select form-select-sm" id="quick-log-level">
                                <option value="DEBUG">DEBUG</option>
                                <option value="INFO">INFO</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Intervalo Stats (s)</label>
                            <input type="number" class="form-control form-control-sm" id="quick-stats-interval" value="60" min="10" max="3600">
                        </div>
                    </div>
                    
                    <!-- Performance Settings -->
                    <div class="col-lg-3 mb-3">
                        <h6 class="text-warning">Rendimiento</h6>
                        <div class="mb-2">
                            <label class="form-label">Temp. Máxima (°C)</label>
                            <input type="number" class="form-control form-control-sm" id="quick-temp-threshold" value="70" min="50" max="85">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="quick-auto-optimize" checked>
                            <label class="form-check-label" for="quick-auto-optimize">
                                Auto-optimización
                            </label>
                        </div>
                    </div>
                    
                    <!-- Database Settings -->
                    <div class="col-lg-3 mb-3">
                        <h6 class="text-info">Base de Datos</h6>
                        <div class="mb-2">
                            <label class="form-label">Retención (días)</label>
                            <input type="number" class="form-control form-control-sm" id="quick-retention-days" value="30" min="1" max="365">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Muestreo (s)</label>
                            <input type="number" class="form-control form-control-sm" id="quick-sampling-interval" value="5" min="1" max="60">
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <button class="btn btn-primary" onclick="applyQuickSettings()">
                        <i class="fas fa-check"></i> Aplicar Configuración Rápida
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Configuration Presets -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-bookmark"></i> Configuraciones Predefinidas
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="loadPreset('development')">
                        <i class="fas fa-code"></i> Desarrollo
                        <small class="d-block text-muted">Debug habilitado, logs detallados</small>
                    </button>
                    <button class="btn btn-outline-success" onclick="loadPreset('production')">
                        <i class="fas fa-industry"></i> Producción
                        <small class="d-block text-muted">Optimizado para rendimiento</small>
                    </button>
                    <button class="btn btn-outline-warning" onclick="loadPreset('testing')">
                        <i class="fas fa-vial"></i> Pruebas
                        <small class="d-block text-muted">Configuración para testing</small>
                    </button>
                    <button class="btn btn-outline-info" onclick="loadPreset('minimal')">
                        <i class="fas fa-compress"></i> Mínimo
                        <small class="d-block text-muted">Uso mínimo de recursos</small>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Configuration Validation -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-check-circle"></i> Validación de Configuración
            </div>
            <div class="card-body">
                <div id="validation-results">
                    <div class="text-center text-muted">
                        <i class="fas fa-shield-alt"></i>
                        <p>Haga clic en "Validar" para verificar la configuración</p>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-outline-primary" onclick="validateConfiguration()">
                        <i class="fas fa-check"></i> Validar Configuración
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentConfig = {};

document.addEventListener('DOMContentLoaded', function() {
    loadConfiguration();
    loadSystemInfo();
    
    // Auto-save draft every 30 seconds
    setInterval(saveDraft, 30000);
});

function loadConfiguration() {
    // In a real implementation, this would load from the server
    // For now, we'll use a default configuration
    const defaultConfig = {
        "serial": {
            "port": "/dev/ttyUSB0",
            "baudrate": 9600,
            "bytesize": 8,
            "parity": "N",
            "stopbits": 1,
            "timeout": 1.0
        },
        "server": {
            "max_slaves": 10,
            "log_level": "INFO",
            "log_file": "/var/log/modbus_server.log",
            "stats_interval": 60,
            "backup_interval": 300
        },
        "performance": {
            "memory_check_interval": 30,
            "cpu_check_interval": 10,
            "auto_optimize": true
        },
        "pi_zero_optimization": {
            "enable_cpu_governor": true,
            "cpu_governor": "performance",
            "enable_memory_optimization": true,
            "swap_usage_threshold": 50,
            "temperature_threshold": 70,
            "throttle_on_overheat": true
        },
        "industrial_features": {
            "enable_watchdog": true,
            "watchdog_timeout": 30,
            "enable_backup": true,
            "backup_directory": "/var/backups/modbus",
            "enable_redundancy": false,
            "redundant_port": "/dev/ttyUSB1"
        },
        "web_server": {
            "host": "0.0.0.0",
            "port": 8080,
            "data_retention_days": 30,
            "sampling_interval": 5
        }
    };
    
    currentConfig = defaultConfig;
    document.getElementById('config-editor').value = JSON.stringify(defaultConfig, null, 4);
    
    // Update quick settings
    updateQuickSettings(defaultConfig);
    
    showAlert('Configuración cargada', 'success');
}

function updateQuickSettings(config) {
    document.getElementById('quick-port').value = config.serial.port;
    document.getElementById('quick-baudrate').value = config.serial.baudrate;
    document.getElementById('quick-log-level').value = config.server.log_level;
    document.getElementById('quick-stats-interval').value = config.server.stats_interval;
    document.getElementById('quick-temp-threshold').value = config.pi_zero_optimization.temperature_threshold;
    document.getElementById('quick-auto-optimize').checked = config.performance.auto_optimize;
    
    if (config.web_server) {
        document.getElementById('quick-retention-days').value = config.web_server.data_retention_days;
        document.getElementById('quick-sampling-interval').value = config.web_server.sampling_interval;
    }
}

function saveConfiguration() {
    try {
        const configText = document.getElementById('config-editor').value;
        const config = JSON.parse(configText);
        
        // Validate configuration
        if (validateConfigurationData(config)) {
            currentConfig = config;
            
            // In a real implementation, this would save to the server
            showAlert('Configuración guardada correctamente', 'success');
            
            // Clear draft
            localStorage.removeItem('modbus_config_draft');
        }
    } catch (error) {
        showAlert('Error en formato JSON: ' + error.message, 'danger');
    }
}

function resetConfiguration() {
    if (confirm('¿Está seguro de que desea restaurar la configuración por defecto?')) {
        loadConfiguration();
        showAlert('Configuración restaurada', 'warning');
    }
}

function applyQuickSettings() {
    try {
        const config = JSON.parse(document.getElementById('config-editor').value);
        
        // Update configuration with quick settings
        config.serial.port = document.getElementById('quick-port').value;
        config.serial.baudrate = parseInt(document.getElementById('quick-baudrate').value);
        config.server.log_level = document.getElementById('quick-log-level').value;
        config.server.stats_interval = parseInt(document.getElementById('quick-stats-interval').value);
        config.pi_zero_optimization.temperature_threshold = parseInt(document.getElementById('quick-temp-threshold').value);
        config.performance.auto_optimize = document.getElementById('quick-auto-optimize').checked;
        
        if (!config.web_server) {
            config.web_server = {};
        }
        config.web_server.data_retention_days = parseInt(document.getElementById('quick-retention-days').value);
        config.web_server.sampling_interval = parseInt(document.getElementById('quick-sampling-interval').value);
        
        document.getElementById('config-editor').value = JSON.stringify(config, null, 4);
        showAlert('Configuración rápida aplicada', 'success');
        
    } catch (error) {
        showAlert('Error aplicando configuración rápida: ' + error.message, 'danger');
    }
}

function loadPreset(presetName) {
    let preset = {};
    
    switch (presetName) {
        case 'development':
            preset = {
                ...currentConfig,
                server: {
                    ...currentConfig.server,
                    log_level: "DEBUG",
                    stats_interval: 30
                },
                performance: {
                    ...currentConfig.performance,
                    memory_check_interval: 10,
                    cpu_check_interval: 5,
                    auto_optimize: false
                }
            };
            break;
            
        case 'production':
            preset = {
                ...currentConfig,
                server: {
                    ...currentConfig.server,
                    log_level: "WARNING",
                    stats_interval: 300
                },
                performance: {
                    ...currentConfig.performance,
                    memory_check_interval: 60,
                    cpu_check_interval: 30,
                    auto_optimize: true
                },
                pi_zero_optimization: {
                    ...currentConfig.pi_zero_optimization,
                    cpu_governor: "performance",
                    enable_memory_optimization: true
                }
            };
            break;
            
        case 'testing':
            preset = {
                ...currentConfig,
                server: {
                    ...currentConfig.server,
                    log_level: "INFO",
                    stats_interval: 10
                },
                web_server: {
                    ...currentConfig.web_server,
                    sampling_interval: 1,
                    data_retention_days: 7
                }
            };
            break;
            
        case 'minimal':
            preset = {
                ...currentConfig,
                server: {
                    ...currentConfig.server,
                    log_level: "ERROR",
                    stats_interval: 600,
                    max_slaves: 5
                },
                performance: {
                    ...currentConfig.performance,
                    memory_check_interval: 120,
                    cpu_check_interval: 60
                },
                web_server: {
                    ...currentConfig.web_server,
                    sampling_interval: 10,
                    data_retention_days: 7
                }
            };
            break;
    }
    
    document.getElementById('config-editor').value = JSON.stringify(preset, null, 4);
    updateQuickSettings(preset);
    showAlert(`Configuración "${presetName}" cargada`, 'info');
}

function validateConfiguration() {
    try {
        const configText = document.getElementById('config-editor').value;
        const config = JSON.parse(configText);
        
        const results = [];
        
        // Validate serial configuration
        if (!config.serial || !config.serial.port) {
            results.push({ type: 'error', message: 'Puerto serie no especificado' });
        }
        
        if (config.serial && (config.serial.baudrate < 1200 || config.serial.baudrate > 115200)) {
            results.push({ type: 'warning', message: 'Baudrate fuera del rango recomendado (1200-115200)' });
        }
        
        // Validate server configuration
        if (config.server && config.server.max_slaves > 50) {
            results.push({ type: 'warning', message: 'Número alto de esclavos puede afectar el rendimiento en Pi Zero 2W' });
        }
        
        // Validate performance settings
        if (config.pi_zero_optimization && config.pi_zero_optimization.temperature_threshold > 80) {
            results.push({ type: 'warning', message: 'Umbral de temperatura alto puede causar throttling' });
        }
        
        // Validate web server settings
        if (config.web_server && config.web_server.sampling_interval < 1) {
            results.push({ type: 'error', message: 'Intervalo de muestreo debe ser al menos 1 segundo' });
        }
        
        if (results.length === 0) {
            results.push({ type: 'success', message: 'Configuración válida' });
        }
        
        displayValidationResults(results);
        
    } catch (error) {
        displayValidationResults([{ type: 'error', message: 'Error de formato JSON: ' + error.message }]);
    }
}

function displayValidationResults(results) {
    const container = document.getElementById('validation-results');
    let html = '';
    
    results.forEach(result => {
        const iconClass = result.type === 'success' ? 'fa-check-circle text-success' :
                         result.type === 'warning' ? 'fa-exclamation-triangle text-warning' :
                         'fa-times-circle text-danger';
        
        html += `
            <div class="d-flex align-items-center mb-2">
                <i class="fas ${iconClass} me-2"></i>
                <span>${result.message}</span>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function validateConfigurationData(config) {
    // Basic validation
    if (!config.serial || !config.server) {
        throw new Error('Configuración incompleta: faltan secciones requeridas');
    }
    
    if (!config.serial.port) {
        throw new Error('Puerto serie requerido');
    }
    
    return true;
}

function loadSystemInfo() {
    fetch('/api/system/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySystemInfo(data.status);
            }
        })
        .catch(error => {
            console.error('Error loading system info:', error);
        });
}

function displaySystemInfo(status) {
    const container = document.getElementById('system-info');
    
    container.innerHTML = `
        <div class="row text-center">
            <div class="col-6 mb-2">
                <small class="text-muted">CPU</small>
                <div class="fw-bold">${status.cpu_percent.toFixed(1)}%</div>
            </div>
            <div class="col-6 mb-2">
                <small class="text-muted">Memoria</small>
                <div class="fw-bold">${status.memory_percent.toFixed(1)}%</div>
            </div>
            <div class="col-6 mb-2">
                <small class="text-muted">Temperatura</small>
                <div class="fw-bold">${status.temperature.toFixed(1)}°C</div>
            </div>
            <div class="col-6 mb-2">
                <small class="text-muted">Uptime</small>
                <div class="fw-bold">${status.uptime}</div>
            </div>
        </div>
        <hr>
        <div class="text-center">
            <small class="text-muted">
                <i class="fas fa-microchip"></i> Raspberry Pi Zero 2W<br>
                ARM Cortex-A53 • 512MB RAM
            </small>
        </div>
    `;
}

function saveDraft() {
    const configText = document.getElementById('config-editor').value;
    localStorage.setItem('modbus_config_draft', configText);
}

function loadDraft() {
    const draft = localStorage.getItem('modbus_config_draft');
    if (draft && confirm('Se encontró un borrador guardado. ¿Desea cargarlo?')) {
        document.getElementById('config-editor').value = draft;
        showAlert('Borrador cargado', 'info');
    }
}

// Load draft on page load if available
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(loadDraft, 1000);
});
</script>
{% endblock %}
